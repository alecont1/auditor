// Prisma schema for AuditEng
// PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Company/Tenant model
model Company {
  id              String   @id @default(uuid())
  name            String
  logoUrl         String?
  defaultStandard String   @default("NETA") // NETA or MICROSOFT
  dateFormat      String   @default("MM/DD/YYYY") // MM/DD/YYYY or DD/MM/YYYY
  tokenBalance    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  users             User[]
  invitations       Invitation[]
  analyses          Analysis[]
  tokenTransactions TokenTransaction[]
  auditLogs         AuditLog[]

  @@map("companies")
}

// User model
model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  passwordHash       String
  name               String
  role               String    @default("ANALYST") // SUPER_ADMIN, ADMIN, ANALYST
  companyId          String?
  emailNotifications Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastLoginAt        DateTime?

  // Relations
  company           Company?           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  analyses          Analysis[]
  tokenTransactions TokenTransaction[]
  invitationsSent   Invitation[]       @relation("InvitedBy")
  auditLogs         AuditLog[]

  @@index([email])
  @@index([companyId])
  @@map("users")
}

// Invitation model for user onboarding
model Invitation {
  id          String    @id @default(uuid())
  email       String
  role        String    @default("ANALYST") // ADMIN or ANALYST
  companyId   String
  invitedById String
  token       String    @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invitedBy User    @relation("InvitedBy", fields: [invitedById], references: [id])

  @@index([token])
  @@index([companyId])
  @@index([expiresAt])
  @@map("invitations")
}

// Analysis model - stores PDF analysis results
model Analysis {
  id                String    @id @default(uuid())
  companyId         String
  userId            String
  testType          String    // GROUNDING, MEGGER, THERMOGRAPHY
  filename          String
  pdfUrl            String
  pdfSizeBytes      Int
  status            String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  verdict           String?   // APPROVED, APPROVED_WITH_COMMENTS, REJECTED
  score             Int?
  overallConfidence Float?
  tokensConsumed    Int       @default(0)
  processingTimeMs  Int?
  extractionData    Json?     // Native PostgreSQL JSONB
  nonConformities   Json?     // Native PostgreSQL JSONB
  requiresReview    Boolean   @default(false)
  standardUsed      String    // NETA or MICROSOFT
  createdAt         DateTime  @default(now())
  completedAt       DateTime?

  // Relations
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user              User               @relation(fields: [userId], references: [id])
  tokenTransactions TokenTransaction[]

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([status])
  @@map("analyses")
}

// Token Transaction model
model TokenTransaction {
  id              String   @id @default(uuid())
  companyId       String
  userId          String
  type            String   // PURCHASE, CONSUMPTION, REFUND
  amount          Int      // Positive for credit, negative for debit
  balance         Int      // Balance after transaction
  analysisId      String?
  stripeSessionId String?  // For future Stripe integration
  packageName     String?  // For future billing
  description     String
  createdAt       DateTime @default(now())

  // Relations
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id])
  analysis Analysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)

  @@index([companyId, createdAt])
  @@index([type])
  @@map("token_transactions")
}

// Audit Log model
model AuditLog {
  id         String   @id @default(uuid())
  companyId  String?
  userId     String
  action     String
  entityType String
  entityId   String
  details    Json?    // Native PostgreSQL JSONB
  ipAddress  String?
  createdAt  DateTime @default(now())

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  user    User     @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([action])
  @@index([entityType, entityId])
  @@map("audit_logs")
}
